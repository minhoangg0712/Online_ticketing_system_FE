<div class="reviews-container">
  <div class="search-filter-row">
    <div class="search-section">
      <div class="search-input-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input
          type="text"
          placeholder="Tìm kiếm theo tên, địa điểm..."
          class="search-input"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        />
        <button 
          *ngIf="searchTerm" 
          class="clear-search-btn" 
          (click)="clearSearch()"
          type="button">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
      
      <div class="filter-container">
        <button class="btn" (click)="toggleFilter()">
          Bộ lọc
        </button>

        <div
          class="filter-popup"
          *ngIf="showFilter"
          appClickOutside
          (clickOutside)="showFilter = false"
        >
          <select
            id="starFilter"
            [(ngModel)]="selectedStar"
            (change)="onStarFilterChange($event)"
            class="star-filter-select"
          >
            <option value="">Tất cả</option>
            <option *ngFor="let star of [5, 4, 3, 2, 1]" [value]="star">
              {{ star }} sao
            </option>
          </select>
        </div>
      </div>
  </div>

    <div *ngIf="!selectedEvent" class="event-list">
    <div *ngIf="isLoadingEvents">Đang tải danh sách sự kiện...</div>
    <ul *ngIf="!isLoadingEvents">
        <li *ngFor="let event of filteredEvents" (click)="selectEvent(event)" style="cursor:pointer; margin-bottom: 18px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <strong>{{ event.eventName }}</strong>
            </div>
            <div *ngIf="event.reviewDetails && event.reviewDetails.length > 0 && getAverageRating(event.reviewDetails) !== null" class="event-rating">
                {{ getAverageRating(event.reviewDetails) }} <span class="star">★</span>
            </div>
            <div *ngIf="!event.reviewDetails || event.reviewDetails.length === 0" class="event-no-rating">
              Chưa có đánh giá
            </div>
          </div>
        </li>
        <li *ngIf="filteredEvents.length === 0">Không có sự kiện nào.</li>
    </ul>
    </div>

    <div *ngIf="selectedEvent" class="event-reviews">
    <button (click)="backToList()">&larr; Quay lại danh sách</button>
    <h2>Đánh giá sự kiện: {{ selectedEvent.eventName }}</h2>

    <div *ngIf="isLoadingReviews">Đang tải đánh giá...</div>
    <ul *ngIf="!isLoadingReviews && reviews && reviews.length > 0" class="review-list">
        <li *ngFor="let review of reviews">
        <img *ngIf="review.userProfilePicture" [src]="review.userProfilePicture" class="review-avatar" alt="avatar" />
        <div class="review-content">
            <div class="review-header">
            <span class="review-user">{{ review.userFullName || 'Ẩn danh' }}</span>
            <span *ngIf="review.rating !== undefined && review.rating !== null" class="review-rating">{{ review.rating }}/5</span>
            <span *ngIf="review.reviewDate" class="review-date">{{ review.reviewDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="review-comment">{{ review.comment }}</div>
        </div>
        </li>
    </ul>
    <ul *ngIf="!isLoadingReviews && (!reviews || reviews.length === 0)" class="review-list">
        <li>Chưa có đánh giá nào cho sự kiện này.</li>
    </ul>
    </div>
  <app-toast-notification 
    #notification
    (onClose)="onNotificationClose()">
  </app-toast-notification>
</div>